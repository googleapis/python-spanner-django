language: python
before_install:
    - openssl aes-256-cbc -K $encrypted_3bd81e4a6a4c_key -iv $encrypted_3bd81e4a6a4c_iv -in appdev-soda-spanner-staging-b842e628aa41-orijtech.json.enc -out ~/creds.json -d

env:
    global:
        - GOOGLE_APPLICATION_CREDENTIALS=~/creds.json
        - RUNNING_SPANNER_BACKEND_TESTS=1
    jobs:
        - DJANGO_TEST_APPS="admin_changelist admin_custom_urls admin_docs admin_inlines"
        - DJANGO_TEST_APPS="admin_ordering aggregation aggregation_regress annotations backends"
        # Commented out because they take longer 2hr and TravisCI unconditionally terminates them.
        # - DJANGO_TEST_APPS="auth_tests"
        - DJANGO_TEST_APPS="basic bulk_create choices custom_columns cache custom_methods custom_pk datatypes dates datetimes"
        - DJANGO_TEST_APPS="defer defer_regress delete_regress db_functions db_utils"
        - DJANGO_TEST_APPS="distinct_on_fields empty expressions expressions_window field_defaults"
        - DJANGO_TEST_APPS="field_subclassing file_storage file_uploads fixtures fixtures_model_package from_db_value get_earliest_or_latest get_object_or_404 i18n"
        - DJANGO_TEST_APPS="indexes inline_formsets introspection invalid_models_tests known_related_objects lookup max_lengths m2m_and_m2o m2m_intermediary m2m_multiple m2m_recursive"
        - DJANGO_TEST_APPS="m2m_regress m2m_signals m2m_through m2m_through_regress"
        - DJANGO_TEST_APPS="m2o_recursive managers_regress many_to_many many_to_one many_to_one_null max_lengths"
        - DJANGO_TEST_APPS="migrate_signals migration_test_data_persistence model_fields.test_binaryfield model_fields.test_booleanfield model_fields.test_charfield"
        # Run model_fields piecemeal because running it all at once takes
        # longer then 2 hours (Travis CI limit).
        - DJANGO_TEST_APPS="model_fields.test_datetimefield model_fields.test_decimalfield model_fields.test_durationfield model_fields.test_field_flags model_fields.test_filefield"
        - DJANGO_TEST_APPS="model_fields.test_floatfield model_fields.test_foreignkey model_fields.test_genericipaddressfield model_fields.test_imagefield model_fields.test_integerfield"
        - DJANGO_TEST_APPS="model_fields.test_manytomanyfield model_fields.test_promises model_fields.test_slugfield model_fields.test_textfield model_fields.test_uuid null_fk null_fk_ordering"
        - DJANGO_TEST_APPS="null_queries one_to_one or_lookups ordering queries.test_bulk_update queries.test_explain"
        - DJANGO_TEST_APPS="queries.test_iterator queries.test_q queries.test_qs_combinators queries.test_query"
        # Commented out because they take longer 2hr and TravisCI unconditionally terminates them.
        # - DJANGO_TEST_APPS="queries.tests"
        - DJANGO_TEST_APPS="raw_query redirects_tests reserved_names reverse_lookup save_delete_hooks select_related select_related_onetoone signing sitemaps_tests string_lookup signals"
        - DJANGO_TEST_APPS="test_utils test_client test_client_regress timezones transactions unmanaged_models update_only_fields update validation view_tests"

python:
    - "3.7"
cache: pip
install:
    - pip install . tox-travis flake8 isort
script:
    - tox
    - flake8
    - isort --recursive --check-only --diff
    - pip3 install .
    - mkdir -p django_tests && git clone --depth 1 --single-branch --branch spanner-2.2.x https://github.com/timgraham/django.git django_tests/django
    - cd django_tests/django && pip3 install -e . && pip3 install -r tests/requirements/py3.txt; cd ../../
    - ./bin/parallelize_tests_linux
